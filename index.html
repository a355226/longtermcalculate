<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é•·ç…§æœå‹™é¡åº¦è©¦ç®—å°å·¥å…·</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; padding: 2em; background-color: #f8f9fa; }
  h2 { text-align: center; color: #333; }
  #actions { display: flex; justify-content: space-between; margin-bottom: 1em; }
  .btn { padding: 0.5em 1em; background-color: #2e86d9; color: white; border: none; border-radius: 4px; cursor: pointer; }
  .btn:hover { background-color: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 1em; }
  th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
  input[type="number"], input[type="text"] { width: 60px; text-align: center; }
  .result { margin-top: 2em; font-size: 1.1em; }
  .blue { color: #007bff; } .red { color: #dc3545; }
  #outputBox { margin-top: 3em; }
  #generatedOutput { width: 100%; height: 100px; margin-bottom: 1em; }
  .delete-btn { cursor: pointer; color: #dc3545; font-weight: bold; font-size: 1.2em; }
  .footer { margin-top: 3em; text-align: right; font-size: 0.8em; color: #aaa; font-family: "Courier New", cursive; }
  .counter-controls button { padding: 0 8px; font-weight: bold; }

  /* âœ… æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆä¸æ»‘å‹•ï¼Œæ ¼å­è®Šçª„ï¼‰ */
@media (max-width: 768px) {
  body {
    padding: 1em;
    font-size: 0.9em;
  }

  #actions {
    flex-direction: column;
    gap: 0.5em;
  }

  .btn {
    width: 100%;
    font-size: 1em;
  }

  table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
  }

th, td {
  font-size: 0.75em;
  padding: 0.25em;
  white-space: normal;
  word-break: break-word;
  overflow: hidden;
}

input[type="number"], input[type="text"] {
  width: 100%;
  font-size: 0.75em;
  box-sizing: border-box;
}

.custom-name {
  width: 100%;
  font-size: 0.75em;
  box-sizing: border-box;
  display: block;
  margin-top: 4px;
}

  .counter-controls {
    flex-direction: column;
    align-items: center;
  }

  .counter-controls button {
    font-size: 0.75em;
    padding: 2px 6px;
    margin: 1px 0;
  }

  #generatedOutput {
    height: 120px;
  }
.select-wrapper {
  display: flex;
  gap: 4px;
  flex-direction: column;
}
.select-wrapper select,
.select-wrapper .custom-name {
  width: 100%;
  font-size: 0.75em;
  box-sizing: border-box;
}
select {
  width: 100%;
  min-width: 60px;
  max-width: 100%;
  box-sizing: border-box;
}

</style>
</head>
<body>
  <h2>ğŸ§® é•·ç…§æœå‹™é¡åº¦è©¦ç®—å°å·¥å…·</h2>
  <div id="actions">
    <button class="btn" onclick="addRow()">â• æ–°å¢æ¬„ä½</button>
    <button class="btn" onclick="clearAll()">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
  </div>

  <table id="serviceTable">
    <thead>
      <tr>
        <th>é …ç›®</th><th>è²»ç”¨</th><th>æ¬¡æ•¸</th><th>å°è¨ˆ</th><th>åˆªé™¤</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="result">
    <p>ğŸ’° <strong>æœå‹™ç¸½é‡‘é¡ï¼š</strong><span id="totalCost">0</span> å…ƒ</p>
    <label>æ”¿åºœè£œåŠ©æ¯”ä¾‹ï¼š
      <select id="subsidyRate" onchange="calculate()">
        <option value="0.16" selected>84%ï¼ˆä¸€èˆ¬æˆ¶ï¼‰</option>
        <option value="0.05">95%ï¼ˆä¸­ä½æ”¶å…¥æˆ¶ï¼‰</option>
        <option value="0">100%ï¼ˆä½æ”¶å…¥æˆ¶ï¼‰</option>
      </select>
    </label>
    <br><br>
    <label>é•·ç…§å¤±èƒ½ç­‰ç´šï¼š
      <select id="disabilityLevel" onchange="calculate()">
        <option value="10020">2 ç´š</option><option value="15460">3 ç´š</option><option value="18580">4 ç´š</option>
        <option value="24100">5 ç´š</option><option value="28070">6 ç´š</option><option value="32090">7 ç´š</option><option value="36180">8 ç´š</option>
      </select>
    </label>
    <label style="margin-left: 1em;">
      <input type="checkbox" id="extraCare" onchange="calculate()"> æœ‰å¤–çœ‹
    </label>

    <p>ğŸ§ <strong>æ°‘çœ¾è‡ªä»˜é‡‘é¡ï¼š</strong><span id="copayAmount">0</span> å…ƒ</p>
    <p>ğŸ›ï¸ <strong>æ”¿åºœè£œåŠ©é‡‘é¡ï¼š</strong><span id="subsidyAmount">0</span> å…ƒ</p>
    <p>ğŸ’µ <strong>å‰©é¤˜é¡åº¦ï¼š</strong><span id="remainingQuota" class="blue">0</span> å…ƒ</p>
  </div>

  <div id="outputBox">
    <textarea id="generatedOutput" readonly></textarea>
    <button class="btn" onclick="generateSummary()">ğŸ“‹ å…§å®¹ç”¢å‡º</button>
    <button class="btn" onclick="copyOutput()">ğŸ–ï¸ ä¸€éµè¤‡è£½</button>
    <div id="copyNotice" style="color: green; margin-top: 0.5em; display: none;">âœ… å·²è¤‡è£½ï¼</div>
  </div>

  <div class="footer">Designed by KJ</div>

  <script>
    const services = {
      "BA01": 260, "BA02": 195, "BA03": 35, "BA04": 130, "BA05": 310,
      "BA07": 325, "BA10": 155, "BA11": 195, "BA12": 130, "BA13": 195,
      "BA14": 685, "BA15": 195, "BA16": 130,
      "BA17a": 75, "BA17b": 65, "BA17c": 50, "BA17d1": 50, "BA17d2": 50,
      "BA17e": 50, "BA18": 200, "BA20": 175, "BA22": 130, "BA23": 200,
      "BA24": 220, "GA09": 770, "SC09": 770, "Cç¢¼(å–®æ¬¡)": 1500, "è‡ªè¡Œè¼¸å…¥": 0
    };

    const serviceOrder = Object.keys(services).filter(k => k.startsWith("BA"))
      .concat(Object.keys(services).filter(k => k.startsWith("GA")))
      .concat(Object.keys(services).filter(k => k.startsWith("SC")))
      .concat(["Cç¢¼(å–®æ¬¡)", "è‡ªè¡Œè¼¸å…¥"]);

    function sumGroup(arr, priceMap) {
      return arr.reduce((sum, item) => {
        const match = item.match(/\*(\d+)/);
        const count = match ? parseInt(match[1]) : 1;
        const name = item.split("*")[0];
        return sum + (priceMap[name] || 0) * count;
      }, 0);
    }

    function generateSummary() {
      const groups = calculate(true);
      let result = [];
      if (groups.BA.length) result.push(groups.BA.join(",") + "," + sumGroup(groups.BA, groups.priceMap));
      if (groups.GA.length || groups.SC.length) {
        const ga = groups.GA.length ? groups.GA.join(",") + "," + sumGroup(groups.GA, groups.priceMap) : "";
        const sc = groups.SC.length ? groups.SC.join(",") + "," + sumGroup(groups.SC, groups.priceMap) : "";
        result.push([ga, sc].filter(Boolean).join(" ; "));
      }
      if (groups.other.length) result.push(groups.other.join(",") + "," + sumGroup(groups.other, groups.priceMap));
      document.querySelector("#generatedOutput").value = result.join("\n");
    }

    function calculate(returnGroup = false) {
      const rows = document.querySelectorAll("#serviceTable tbody tr");
      let total = 0, copayTotal = 0;
      const subsidyRate = parseFloat(document.querySelector("#subsidyRate").value);
      let outputGroups = { BA: [], GA: [], SC: [], other: [], priceMap: {} };

      rows.forEach(row => {
        const select = row.querySelector("select");
        const serviceCode = select.value;
        const nameInput = row.querySelector(".custom-name");
        const name = nameInput ? nameInput.value : serviceCode;
        const price = parseInt(row.querySelector(".price-input").value || 0);
        const count = parseInt(row.querySelector(".count-input").value || 0);
        const subtotal = price * count;
        row.cells[3].textContent = subtotal;
        total += subtotal;

        const perItemCopay = Math.floor(price * subsidyRate);
        copayTotal += perItemCopay * count;

        const item = `${name}*${count}`;
        outputGroups.priceMap[name] = price;
        if (serviceCode.startsWith("BA") || serviceCode === "è‡ªè¡Œè¼¸å…¥") outputGroups.BA.push(item);
        else if (serviceCode.startsWith("GA")) outputGroups.GA.push(item);
        else if (serviceCode.startsWith("SC")) outputGroups.SC.push(item);
        else outputGroups.other.push(item);
      });

      const subsidy = total - copayTotal;
      const levelQuota = parseInt(document.querySelector("#disabilityLevel").value);
      const hasExtraCare = document.querySelector("#extraCare").checked;
      const finalQuota = hasExtraCare ? Math.floor(levelQuota * 0.3) : levelQuota;
      const remaining = finalQuota - total;

      document.querySelector("#totalCost").textContent = total;
      document.querySelector("#copayAmount").textContent = copayTotal;
      document.querySelector("#subsidyAmount").textContent = subsidy;
      const remainEl = document.querySelector("#remainingQuota");
      remainEl.textContent = remaining;
      remainEl.className = remaining >= 0 ? "blue" : "red";

      return outputGroups;
    }

    function clearAll() {
      document.querySelector("#serviceTable tbody").innerHTML = "";
      calculate();
    }

    function addRow() {
      const tbody = document.querySelector("#serviceTable tbody");
      const row = document.createElement("tr");

      const serviceCell = document.createElement("td");
      const select = document.createElement("select");
      serviceOrder.forEach(key => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
      });

      select.onchange = () => {
        const priceInput = row.querySelector(".price-input");
        const customInput = row.querySelector(".custom-name");
if (select.value === "è‡ªè¡Œè¼¸å…¥") {
  if (!serviceCell.querySelector(".select-wrapper")) {
    const wrapper = document.createElement("div");
    wrapper.className = "select-wrapper";
    wrapper.appendChild(select);

    const input = document.createElement("input");
    input.type = "text";
    input.className = "custom-name";
    input.placeholder = "é …ç›®åç¨±";
    wrapper.appendChild(input);

    serviceCell.innerHTML = "";
    serviceCell.appendChild(wrapper);
  }
  priceInput.readOnly = false;
        } else {
          if (customInput) customInput.remove();
          priceInput.value = services[select.value];
          priceInput.readOnly = true;
        }
        calculate();
      };
      serviceCell.appendChild(select);
      row.appendChild(serviceCell);

      const priceCell = document.createElement("td");
      const priceInput = document.createElement("input");
      priceInput.type = "number";
      priceInput.className = "price-input";
      priceInput.value = services[select.value];
      priceInput.readOnly = true;
      priceInput.oninput = calculate;
      priceCell.appendChild(priceInput);
      row.appendChild(priceCell);

      const countCell = document.createElement("td");
      const wrapper = document.createElement("div");
      wrapper.className = "counter-controls";

      const minusBtn = document.createElement("button");
      minusBtn.textContent = "-";
      minusBtn.onclick = () => {
        if (countInput.value > 0) {
          countInput.value--;
          calculate();
        }
      };
      const countInput = document.createElement("input");
      countInput.type = "number";
      countInput.className = "count-input";
      countInput.min = 0;
      countInput.value = 1;
      countInput.oninput = calculate;

      const plusBtn = document.createElement("button");
      plusBtn.textContent = "+";
      plusBtn.onclick = () => {
        countInput.value++;
        calculate();
      };

      wrapper.appendChild(minusBtn);
      wrapper.appendChild(countInput);
      wrapper.appendChild(plusBtn);
      countCell.appendChild(wrapper);
      row.appendChild(countCell);

      const subtotalCell = document.createElement("td");
      subtotalCell.textContent = services[select.value];
      row.appendChild(subtotalCell);

      const deleteCell = document.createElement("td");
      const deleteBtn = document.createElement("span");
      deleteBtn.textContent = "ğŸ—‘ï¸";
      deleteBtn.className = "delete-btn";
      deleteBtn.onclick = () => {
        row.remove();
        calculate();
      };
      deleteCell.appendChild(deleteBtn);
      row.appendChild(deleteCell);

      tbody.appendChild(row);
      calculate();
    }

    function copyOutput() {
      const output = document.querySelector("#generatedOutput");
      output.select();
      output.setSelectionRange(0, 99999);
      document.execCommand("copy");
      const notice = document.querySelector("#copyNotice");
      notice.style.display = "block";
      setTimeout(() => { notice.style.display = "none"; }, 3000);
    }

    window.onload = () => addRow();
  </script>
</body>
</html>
