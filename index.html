<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>é•·ç…§é¡åº¦è©¦ç®—å°å·¥å…·</title>
<!-- ç¶²é  Faviconï¼ˆæ¡Œæ©Ÿï¼‰ -->
<link rel="icon" type="image/png" sizes="32x32" href="icon.png">

<!-- Apple iOS å°ˆç”¨ -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android Chrome å°ˆç”¨ -->
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="manifest" href="manifest.json">

<style>
  body { font-family: 'Segoe UI', sans-serif; padding: 2em; background-color: #f8f9fa; }
  h2 { text-align: center; color: #333; }
  #actions { display: flex; justify-content: space-between; margin-bottom: 1em; }
  .btn { padding: 0.5em 1em; background-color: #2e86d9; color: white; border: none; border-radius: 4px; cursor: pointer; }
  .btn:hover { background-color: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 1em; }
  th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
  input[type="number"], input[type="text"] { width: 60px; text-align: center; }
  .result { margin-top: 2em; font-size: 1.1em; }
  .blue { color: #007bff; } .red { color: #dc3545; }
  #outputBox { margin-top: 3em; }
  #generatedOutput { width: 100%; height: 100px; margin-bottom: 1em; }
  .delete-btn { cursor: pointer; color: #dc3545; font-weight: bold; font-size: 1.2em; }
  .footer { margin-top: 3em; text-align: right; font-size: 0.8em; color: #aaa; font-family: "Courier New", cursive; }
  .counter-controls button { padding: 0 8px; font-weight: bold; }

  /* âœ… æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆä¸æ»‘å‹•ï¼Œæ ¼å­è®Šçª„ï¼‰ */
@media (max-width: 768px) {
  body {
    padding: 1em;
    font-size: 0.9em;
  }

  #actions {
  flex-direction: row;
  flex-wrap: wrap;
  gap: 0.5em;
  justify-content: space-between;
}

	#actions .btn {
  flex: 1 1 30%;
  font-size: 0.85em;
}

  .btn {
    width: 100%;
    font-size: 1em;
  }

  table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
  }

th, td {
  font-size: 0.75em;
  padding: 0.25em;
  white-space: normal;
  word-break: break-word;
  overflow: hidden;
}

input[type="number"], input[type="text"] {
  width: 100%;
  font-size: 0.75em;
  box-sizing: border-box;
}

.custom-name {
  width: 100%;
  font-size: 0.75em;
  box-sizing: border-box;
  display: block;
  margin-top: 4px;
}

  .counter-controls {
    flex-direction: column;
    align-items: center;
  }

 .counter-controls button {
  font-size: 1.2em;
  padding: 0px 12px;
  margin: 2px 0;
  border-radius: 4px;
}

  #generatedOutput {
    height: 120px;
  }
.select-wrapper {
  display: flex;
  gap: 4px;
  flex-direction: column;
}
.select-wrapper select,
.select-wrapper .custom-name {
  width: 100%;
  font-size: 0.75em;
  box-sizing: border-box;
}
select {
  width: 100%;
  min-width: 60px;
  max-width: 100%;
  box-sizing: border-box;
}
  /* âœ… è£œå¼·æ‰‹æ©Ÿé»æ“Šé«”é©— */
  button,
  .btn,
  .counter-controls button {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }	
	/* âœ… å¥—ç”¨æ¬¡æ•¸å½ˆçª—æ¨£å¼èª¿æ•´ */
#countOverlay .modal-content {
  background: white;
  width: 95%;
  max-width: 400px;
  padding: 1.5em 1em;
  box-sizing: border-box;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
}

#countOverlay input#countValue {
  width: 100%;
  font-size: 1.1em;
  padding: 0.6em;
  margin-bottom: 1em;
  box-sizing: border-box;
}

#countOverlay .button-group {
  display: flex;
  justify-content: space-between;
  gap: 0.75em;
}

#countOverlay .button-group .btn {
  flex: 1;
  white-space: nowrap;
  font-size: 1em;
}
}

#countOverlay input#countValue {
  width: 100%;
  font-size: 1em;
  padding: 0.5em;
  margin-bottom: 1em;
  box-sizing: border-box;
}
	/* âœ… ä¿®æ­£å½ˆå‡ºè¦–çª—èˆ‡è¼¸å…¥æ¡†æ¨£å¼ */

/* âœ… æŒ‰éˆ•å®¹å™¨ï¼ˆè®“æŒ‰éˆ•ä¸é‡ç–Šï¼‰ */
#countOverlay .button-group {
  display: flex;
  justify-content: space-between;
  gap: 0.5em;
}

#countOverlay .button-group .btn {
  flex: 1;
  white-space: nowrap;
}
/* é€šç”¨ï¼šæ‰€æœ‰è¢å¹•éƒ½ç½®ä¸­ */
#countOverlay .modal-content{
  background:#fff;
  width:95%;
  max-width:400px;
  padding:1.5em 1em;
  box-sizing:border-box;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  border-radius:10px;
  text-align:center;
  box-shadow:0 0 20px rgba(0,0,0,.2);
}

/* è¼¸å…¥æ¡† */
#countOverlay input#countValue{
  width:100%;
  font-size:1.1em;
  padding:.6em;
  margin-bottom:1em;
  box-sizing:border-box;
}

/* æŒ‰éˆ•æ©«æ’ä¸é‡ç–Š */
#countOverlay .button-group{
  display:flex;
  justify-content:space-between;
  gap:.75em;
}
#countOverlay .button-group .btn{
  flex:1;
  white-space:nowrap;
}

.selector-button {
  background-color: #e0f0ff;
  border: 1px solid #9cc7f3;
  padding: 0.3em 0.6em;
  border-radius: 5px;
  cursor: pointer;
  display: inline-block;
  text-align: center;
  font-size: 0.9em;
  width: 100%;
  box-sizing: border-box;
}

.popup-btn {
  background-color: #e0f0ff;
  border: 1px solid #9cc7f3;
  padding: 0.5em 0.6em;
  border-radius: 5px;
  cursor: pointer;
  width: 100%;
  box-sizing: border-box;
  font-size: 0.9em;
}

.popup-btn:hover {
  background-color: #d0e8ff;
}

.selector-button {
  background-color: #e0f0ff;
  border: 1px solid #9cc7f3;
  padding: 0.3em 0.6em;
  border-radius: 5px;
  cursor: pointer;
  display: inline-block;
  text-align: center;
  font-size: 0.9em;
  width: 100%;
  box-sizing: border-box;
}

.popup-btn {
  background-color: #e0f0ff;
  border: 1px solid #9cc7f3;
  padding: 0.5em 0.6em;
  border-radius: 5px;
  cursor: pointer;
  width: 100%;
  box-sizing: border-box;
  font-size: 0.9em;
}

.popup-btn:hover {
  background-color: #d0e8ff;
}

#popupGrid {
  display: flex;
  gap: 0.75em;
  justify-content: center;
}

</style>
</head>
<body>
  <h2><img src="icon.png" alt="icon" style="height: 1.5em; vertical-align: middle; margin-right: 0.3em;">é•·ç…§é¡åº¦è©¦ç®—å·¥å…·</h2>
  <div id="actions">
    <button class="btn" id="addRowBtn">â• æ–°å¢æ¬„ä½</button>
	<button class="btn" onclick="applyCount()">ğŸ“Œ å¥—ç”¨æ¬¡æ•¸</button>
    <button class="btn" onclick="clearAll()">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
  </div>

  <table id="serviceTable">
    <thead>
      <tr>
        <th>é …ç›®</th><th>è²»ç”¨</th><th>æ¬¡æ•¸</th><th>å°è¨ˆ</th><th>åˆªé™¤</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<div class="result" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1em;">
  <!-- å·¦å´åŸæœ¬è³‡è¨Š -->
  <div style="flex: 1;">
    <p>ğŸ’° <strong>æœå‹™ç¸½é¡ï¼š</strong><span id="totalCost">0</span> å…ƒ</p>
    <label>æ”¿åºœè£œåŠ©æ¯”ä¾‹ï¼š
  <select id="subsidyRate" onchange="calculate()" style="width: 9em;">
        <option value="0.16" selected>84%ï¼ˆä¸€èˆ¬ï¼‰</option>
        <option value="0.05">95%ï¼ˆä¸­ä½ï¼‰</option>
        <option value="0">100%ï¼ˆä½æ”¶ï¼‰</option>
      </select>
    </label>
    <br><br>
   <label>é•·ç…§å¤±èƒ½ç­‰ç´šï¼š
  <select id="disabilityLevel" onchange="calculate()" style="width: 9em;">
        <option value="10020">2 ç´š</option><option value="15460">3 ç´š</option><option value="18580">4 ç´š</option>
        <option value="24100">5 ç´š</option><option value="28070">6 ç´š</option><option value="32090">7 ç´š</option><option value="36180">8 ç´š</option>
      </select>
    </label>
    <label style="margin-left: 1em;">
      <input type="checkbox" id="extraCare" onchange="calculate()"> æœ‰å¤–çœ‹
    </label>

    <p>ğŸ§ <strong>æ°‘çœ¾è‡ªä»˜é¡ï¼š</strong><span id="copayAmount">0</span> å…ƒ</p>
    <p>ğŸ›ï¸ <strong>æ”¿åºœè£œåŠ©é¡ï¼š</strong><span id="subsidyAmount">0</span> å…ƒ</p>
    <p>ğŸ’µ <strong>å‰©é¤˜é¡åº¦ï¼š</strong><span id="remainingQuota" class="blue">0</span> å…ƒ</p>
  </div>

  <!-- å³å´æ–°å¢è¨˜æ†¶é¸é … -->
<fieldset id="memoryFieldset" style="border: 1px solid #ccc; padding: 0.75em 1em; border-radius: 6px; font-size: 0.95em; margin-top: 1.5em;">
    <legend style="font-weight: bold;">ğŸ”åˆ‡æ›</legend>
    <label><input type="radio" name="memorySlot" value="1" checked> è¨˜æ†¶1</label><br>
    <label><input type="radio" name="memorySlot" value="2"> è¨˜æ†¶2</label><br>
    <label><input type="radio" name="memorySlot" value="3"> è¨˜æ†¶3</label>
  </fieldset>
</div>
  <div id="outputBox">
	<label for="caseName">ğŸ‘¤ å€‹æ¡ˆï¼š</label>
<input type="text" id="caseName" placeholder="é¸å¡«" style="margin-bottom: 0.5em; width: 6em; display: inline-block; margin-right: 1em;">
	<textarea id="generatedOutput" readonly></textarea>
    <button class="btn" onclick="generateSummary()">ğŸ“‹ å…§å®¹ç”¢å‡º</button>
    <button class="btn" onclick="copyOutput()">ğŸ–ï¸ ä¸€éµè¤‡è£½</button>
    <div id="copyNotice" style="color: green; margin-top: 0.5em; display: none;">âœ… å·²è¤‡è£½ï¼</div>
<div style="margin-top: 0.5em;">
  <button class="btn" onclick="shareToLine()">ğŸ“¤ åˆ†äº«</button>
  <a href="https://cdn.jsdelivr.net/gh/a355226/longtermcalculate@main/longtermpricelist.jpg" target="_blank" style="margin-left: 1em; font-size: 0.9em;">ğŸ“„ é …ç›®åŠè²»ç”¨ä¸€è¦½è¡¨</a>
</div>

<!-- å¥—ç”¨æ¬¡æ•¸è¼¸å…¥å½ˆçª— -->
<div id="countOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999;">
<div class="modal-content">
  <p>è«‹è¼¸å…¥è¦å¥—ç”¨çš„æ¬¡æ•¸ï¼š</p>
  <input id="countValue" type="number" inputmode="numeric" pattern="[0-9]*" min="0" />
  <div class="button-group">
    <button class="btn" onclick="confirmApplyCount()">ç¢ºèªå¥—ç”¨</button>
    <button class="btn" onclick="closeCountOverlay()" style="background-color: #ccc;">å–æ¶ˆ</button>
  </div>
</div>


  </div>

  <div class="footer">Designed by KJ</div>

  <script>
const services = {
  "BA01": 260, "BA02": 195, "BA03": 35, "BA04": 130, "BA05": 310,
  "BA07": 325, "BA10": 155, "BA11": 195, "BA12": 130, "BA13": 195,
  "BA14": 685, "BA15": 195, "BA16": 130,
  "BA17a": 75, "BA17b": 65, "BA17c": 50, "BA17d1": 50, "BA17d2": 50,
  "BA17e": 50, "BA18": 200, "BA20": 175, "BA22": 130, "BA23": 200,
  "BA24": 220, "GA09": 770, "SC09": 770, "Cç¢¼(å–®æ¬¡)": 1500, "è‡ªè¡Œè¼¸å…¥": 0
};

    const serviceOrder = Object.keys(services).filter(k => k.startsWith("BA"))
      .concat(Object.keys(services).filter(k => k.startsWith("GA")))
      .concat(Object.keys(services).filter(k => k.startsWith("SC")))
      .concat(["Cç¢¼(å–®æ¬¡)", "è‡ªè¡Œè¼¸å…¥"]);

    function sumGroup(arr, priceMap) {
      return arr.reduce((sum, item) => {
        const match = item.match(/\*(\d+)/);
        const count = match ? parseInt(match[1]) : 1;
        const name = item.split("*")[0];
        return sum + (priceMap[name] || 0) * count;
      }, 0);
    }

function generateSummary() {
  const groups = calculate(true);
  const caseName = document.querySelector("#caseName").value.trim();
  const priceMap = groups.priceMap;
  let result = [];

  // âœ… è™•ç† BA å€å¡Š
  if (groups.BA.length) {
    const customItems = groups.BA.filter(item => {
      const code = item.split("*")[0];
      return !(code in services);
    });
	const standardItems = groups.BA.filter(item => {
  const code = item.split("*")[0];
  return code in services;
});

standardItems.sort((a, b) => {
  const codeA = a.split("*")[0];
  const codeB = b.split("*")[0];
  return serviceOrder.indexOf(codeA) - serviceOrder.indexOf(codeB);
});
    let line = "";
    if (caseName) {
  const levelText = document.querySelector("#disabilityLevel").selectedOptions[0].textContent;
  line += `${caseName}ï¼ˆ${levelText}ï¼‰ï¼š`;
}

    if (customItems.length) line += customItems.join(";") + (standardItems.length ? ";" : "");
    if (standardItems.length) line += standardItems.join(",");

const baTotal = sumGroup(groups.BA, priceMap);
line += "," + baTotal;

// âœ… åŠ å…¥è¶…é¡åˆ¤æ–·èˆ‡æ¨™ç¤º
const levelQuota = parseInt(document.querySelector("#disabilityLevel").value);
const hasExtraCare = document.querySelector("#extraCare").checked;
const finalQuota = hasExtraCare ? Math.floor(levelQuota * 0.3) : levelQuota;

if (baTotal > finalQuota) {
  line += `ï¼ˆè¶…é¡${baTotal - finalQuota}ï¼‰`;
}


    result.push(line);
  }

  // âœ… è™•ç† GA èˆ‡ SC å€å¡Š
  if (groups.GA.length || groups.SC.length) {
    const ga = groups.GA.length ? groups.GA.join(",") + "," + sumGroup(groups.GA, priceMap) : "";
    const sc = groups.SC.length ? groups.SC.join(",") + "," + sumGroup(groups.SC, priceMap) : "";
    result.push([ga, sc].filter(Boolean).join(" ; "));
  }

  // âœ… è™•ç†å…¶ä»–é …ç›®ï¼ˆå¦‚ Cç¢¼ï¼‰
  if (groups.other.length) {
    let line = groups.other.join(",") + "," + sumGroup(groups.other, priceMap);
    result.push(line);  // â— ä¸å†åŠ ä¸Šå€‹æ¡ˆåç¨±
  }

  document.querySelector("#generatedOutput").value = result.join("\n");
}

    function calculate(returnGroup = false) {
  const rows = document.querySelectorAll("#serviceTable tbody tr");
  let total = 0, copayTotal = 0, totalForQuota = 0;
  const subsidyRate = parseFloat(document.querySelector("#subsidyRate").value);
  let outputGroups = { BA: [], GA: [], SC: [], other: [], priceMap: {} };

  rows.forEach(row => {
    const select = row.querySelector("select");
    const selectorBox = row.querySelector(".selector-button");
const serviceCode = selectorBox ? selectorBox.dataset.value : "";
    const nameInput = row.querySelector(".custom-name");
    const name = nameInput ? nameInput.value : serviceCode;
    const price = parseInt(row.querySelector(".price-input").value || 0);
    const count = parseInt(row.querySelector(".count-input").value || 0);
    const subtotal = price * count;
    row.cells[3].textContent = subtotal;
    total += subtotal;

    // åªæœ‰ BA æˆ– è‡ªè¡Œè¼¸å…¥çš„æ‰åˆ—å…¥å‰©é¤˜é¡åº¦è¨ˆç®—
    if (serviceCode.startsWith("BA") || serviceCode === "è‡ªè¡Œè¼¸å…¥") {
      totalForQuota += subtotal;
    }

    const perItemCopay = Math.floor(price * subsidyRate);
    copayTotal += perItemCopay * count;

    const item = `${name}*${count}`;
    outputGroups.priceMap[name] = price;
    if (serviceCode.startsWith("BA") || serviceCode === "è‡ªè¡Œè¼¸å…¥") outputGroups.BA.push(item);
    else if (serviceCode.startsWith("GA")) outputGroups.GA.push(item);
    else if (serviceCode.startsWith("SC")) outputGroups.SC.push(item);
    else outputGroups.other.push(item);
  });

  const subsidy = total - copayTotal;
  const levelQuota = parseInt(document.querySelector("#disabilityLevel").value);
  const hasExtraCare = document.querySelector("#extraCare").checked;
  const finalQuota = hasExtraCare ? Math.floor(levelQuota * 0.3) : levelQuota;
  const remaining = finalQuota - totalForQuota;

  document.querySelector("#totalCost").textContent = total;
  document.querySelector("#copayAmount").textContent = copayTotal;
  document.querySelector("#subsidyAmount").textContent = subsidy;
  const remainEl = document.querySelector("#remainingQuota");
  remainEl.textContent = remaining;
  remainEl.className = remaining >= 0 ? "blue" : "red";

  return outputGroups;
}

    function clearAll() {
      document.querySelector("#serviceTable tbody").innerHTML = "";
      calculate();
    }

function addRow() {
  const tbody = document.querySelector("#serviceTable tbody");
  const row = document.createElement("tr");

  // --------- é …ç›®æ¬„ä½ ----------
  const serviceCell = document.createElement("td");
  const wrapper = document.createElement("div");
  wrapper.className = "select-wrapper";

  const selectorBox = document.createElement("div");
  selectorBox.className = "selector-button";
  selectorBox.textContent = "è«‹é¸æ“‡";
  selectorBox.dataset.value = "";
selectorBox.style.color = "#7B7B7B";


  wrapper.appendChild(selectorBox);
  serviceCell.appendChild(wrapper);
  row.appendChild(serviceCell);

  selectorBox.onclick = () => {
  openPopup((selectedCode) => {
    selectorBox.textContent = selectedCode;
    selectorBox.dataset.value = selectedCode;
    selectorBox.style.color = ""; // âœ… è®“é¸åˆ°é …ç›®å¾Œæ¢å¾©é è¨­é»‘è‰²

      const priceInput = row.querySelector(".price-input");
priceInput.value = services[selectedCode] || 0;

if (selectedCode === "è‡ªè¡Œè¼¸å…¥") {
  priceInput.type = "text";
  priceInput.inputMode = "numeric";
  priceInput.pattern = "[0-9]*";
  priceInput.readOnly = false;
priceInput.onfocus = () => priceInput.select(); 
} else {
  priceInput.type = "number";
  priceInput.readOnly = true;
}


      // æ¸…ç©º wrapper ä¸¦é‡æ–°æ’å…¥é¸æ“‡å™¨èˆ‡è¼¸å…¥æ¬„ï¼ˆè‹¥éœ€è¦ï¼‰
      wrapper.innerHTML = '';
      wrapper.appendChild(selectorBox);

      if (selectedCode === "è‡ªè¡Œè¼¸å…¥") {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "custom-name";
        input.placeholder = "é …ç›®åç¨±";
        input.oninput = () => input.value = input.value.toUpperCase();
        wrapper.appendChild(input);
      }

      calculate();
    });
  };

  // --------- è²»ç”¨æ¬„ä½ ----------
  const priceCell = document.createElement("td");
  const priceInput = document.createElement("input");
  priceInput.type = "number";
  priceInput.className = "price-input";
  priceInput.inputMode = "numeric";
  priceInput.pattern = "[0-9]*";
  priceInput.value = 0;
  priceInput.readOnly = true;
  priceInput.oninput = calculate;
  priceCell.appendChild(priceInput);
  row.appendChild(priceCell);

  // --------- æ¬¡æ•¸æ¬„ä½ ----------
  const countCell = document.createElement("td");
  const counter = document.createElement("div");
  counter.className = "counter-controls";

  const minusBtn = document.createElement("button");
  minusBtn.textContent = "-";

  const countInput = document.createElement("input");
  countInput.type = "number";
  countInput.className = "count-input";
  countInput.inputMode = "numeric";
  countInput.pattern = "[0-9]*";
  countInput.min = 0;
  countInput.value = 1;
  countInput.onfocus = () => countInput.select();
  countInput.oninput = calculate;

  const plusBtn = document.createElement("button");
  plusBtn.textContent = "+";

  minusBtn.addEventListener("pointerdown", () => {
    if (countInput.value > 0) {
      countInput.value--;
      calculate();
    }
  });

  plusBtn.addEventListener("pointerdown", () => {
    countInput.value++;
    calculate();
  });

  counter.appendChild(minusBtn);
  counter.appendChild(countInput);
  counter.appendChild(plusBtn);
  countCell.appendChild(counter);
  row.appendChild(countCell);

  // --------- å°è¨ˆæ¬„ä½ ----------
  const subtotalCell = document.createElement("td");
  subtotalCell.textContent = "0";
  row.appendChild(subtotalCell);

  // --------- åˆªé™¤æ¬„ä½ ----------
  const deleteCell = document.createElement("td");
  const deleteBtn = document.createElement("span");
  deleteBtn.textContent = "ğŸ—‘ï¸";
  deleteBtn.className = "delete-btn";
  deleteBtn.onclick = () => {
    row.remove();
    calculate();
  };
  deleteCell.appendChild(deleteBtn);
  row.appendChild(deleteCell);

  tbody.appendChild(row);
  calculate();
}


    function copyOutput() {
      const output = document.querySelector("#generatedOutput");
      output.select();
      output.setSelectionRange(0, 99999);
      document.execCommand("copy");
      const notice = document.querySelector("#copyNotice");
      notice.style.display = "block";
      setTimeout(() => { notice.style.display = "none"; }, 3000);
    }
	function applyCount() {
  const value = prompt("è«‹è¼¸å…¥è¦å¥—ç”¨çš„æ¬¡æ•¸æ•¸å­—ï¼š");
  const num = parseInt(value);
  if (isNaN(num) || num < 0) {
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸ã€‚");
    return;
  }

  document.querySelectorAll(".count-input").forEach(input => {
    input.value = num;
  });

  calculate();
}

    window.onload = () => addRow();

    // ä»¥ä¸‹æ˜¯æ–°å¢åŠŸèƒ½å‡½å¼ï¼ˆè«‹ç›´æ¥è²¼ä¸Šï¼‰
let hasBoundEnter = false;

function applyCount() {
  document.getElementById("countOverlay").style.display = "block";
  const input = document.getElementById("countValue");

  // åªç¶å®šä¸€æ¬¡ Enter éµäº‹ä»¶
  if (!hasBoundEnter) {
    input.addEventListener("keyup", function(e) {
      if (e.key === "Enter") {
        confirmApplyCount();
      }
    });
    hasBoundEnter = true;
  }

  input.focus(); // è‡ªå‹•èšç„¦è¼¸å…¥æ¡†
}


    function confirmApplyCount() {
      const value = document.getElementById("countValue").value;
      const num = parseInt(value);
      if (isNaN(num) || num < 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸ã€‚");
        return;
      }

      document.querySelectorAll(".count-input").forEach(input => {
        input.value = num;
      });

      closeCountOverlay();
      calculate();
    }

    function closeCountOverlay() {
      document.getElementById("countOverlay").style.display = "none";
      document.getElementById("countValue").value = "";
    }

// âœ… ä½¿ç”¨æ‰‹æ©ŸåŸç”Ÿåˆ†äº«åŠŸèƒ½ï¼ˆWeb Share APIï¼‰
function shareToLine() {
  const text = document.querySelector("#generatedOutput").value.trim();
  if (!text) {
    alert("è«‹å…ˆç”¢å‡ºå…§å®¹ï¼");
    return;
  }

  if (navigator.share) {
    navigator.share({
      title: "é•·ç…§æœå‹™è©¦ç®—å…§å®¹",
      text: text
    }).catch(err => {
      console.error("åˆ†äº«å–æ¶ˆæˆ–å¤±æ•—", err);
    });
  } else {
    alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´åŸç”Ÿåˆ†äº«åŠŸèƒ½ã€‚");
  }
}

// âœ… åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½® + æ”¯æ´ Web Shareï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºåˆ†äº«æŒ‰éˆ•
window.onload = () => {
  addRow(); // åŸæœ¬çš„åŠŸèƒ½

  // ğŸ‘‰ åŠ å…¥è£ç½®åµæ¸¬åˆ¤æ–·æ˜¯å¦éš±è—åˆ†äº«æŒ‰éˆ•
  const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
  const shareSupported = typeof navigator.share === "function";

  const shareBtn = document.getElementById("shareBtn");
  if (shareBtn && (!isMobile || !shareSupported)) {
    shareBtn.style.display = "none";
  }
};
// âœ… é˜²æ­¢ iOS é›™æ“Šè§¸ç™¼ç¸®æ”¾ï¼ˆä¿ç•™åŸå­—é«”å¤§å°ï¼‰
let lastTouch = 0;
document.addEventListener('touchend', function (e) {
  const now = new Date().getTime();
  if (now - lastTouch <= 300) {
    e.preventDefault(); // é˜»æ­¢ç¬¬äºŒæ¬¡é»æ“Šå°è‡´ç¸®æ”¾
  }
  lastTouch = now;
}, { passive: false });
document.getElementById("addRowBtn").addEventListener("pointerdown", addRow);

const memories = { 1: null, 2: null, 3: null };
let currentMemory = 1;

function captureState() {
  const rows = [];
  document.querySelectorAll("#serviceTable tbody tr").forEach(row => {
    const select = row.querySelector("select");
    const selectorBox = row.querySelector(".selector-button");
const serviceCode = selectorBox ? selectorBox.dataset.value : "";
    const customName = row.querySelector(".custom-name")?.value || "";
    const price = parseInt(row.querySelector(".price-input").value || 0);
    const count = parseInt(row.querySelector(".count-input").value || 0);
    rows.push({ serviceCode, customName, price, count });
  });

  return {
    rows,
    subsidyRate: document.getElementById("subsidyRate").value,
    disabilityLevel: document.getElementById("disabilityLevel").value,
    extraCare: document.getElementById("extraCare").checked,
    caseName: document.getElementById("caseName").value,
    generatedOutput: document.getElementById("generatedOutput").value
  };
}

function restoreState(state) {
  clearAll();

  state.rows.forEach(data => {
    addRow(); // å…ˆæ–°å¢ä¸€åˆ—
    const rows = document.querySelectorAll("#serviceTable tbody tr");
    const row = rows[rows.length - 1]; // å–å‰›å‰›æ–°å¢çš„é‚£ä¸€åˆ—

    const selectorBox = row.querySelector(".selector-button");
    const priceInput = row.querySelector(".price-input");
    const countInput = row.querySelector(".count-input");

    if (data.serviceCode) {
  selectorBox.textContent = data.serviceCode;
  selectorBox.dataset.value = data.serviceCode;
  selectorBox.style.color = "";
} else {
  selectorBox.textContent = "è«‹é¸æ“‡";
  selectorBox.dataset.value = "";
  selectorBox.style.color = "#7B7B7B"; // é‚„åŸç°è‰²
}

    priceInput.value = data.price;
    countInput.value = data.count;

    if (data.serviceCode === "è‡ªè¡Œè¼¸å…¥") {
      priceInput.readOnly = false;
      priceInput.type = "text";
      const input = document.createElement("input");
      input.type = "text";
      input.className = "custom-name";
      input.placeholder = "é …ç›®åç¨±";
      input.value = data.customName;
      input.addEventListener("input", () => {
        input.value = input.value.toUpperCase();
      });
      row.querySelector(".select-wrapper").appendChild(input);
    } else {
      priceInput.readOnly = true;
    }
  });

  document.getElementById("subsidyRate").value = state.subsidyRate;
  document.getElementById("disabilityLevel").value = state.disabilityLevel;
  document.getElementById("extraCare").checked = state.extraCare;
  document.getElementById("caseName").value = state.caseName;
  document.getElementById("generatedOutput").value = state.generatedOutput;

  calculate();
}


document.getElementById("memoryFieldset").addEventListener("change", e => {
  if (e.target.name === "memorySlot") {
    memories[currentMemory] = captureState();
    currentMemory = parseInt(e.target.value);
    if (memories[currentMemory]) {
      restoreState(memories[currentMemory]);
    } else {
      clearAll();
      document.getElementById("caseName").value = "";
      document.getElementById("generatedOutput").value = "";
      calculate();
    }
  }
});

// âœ… ä¿®æ­£ generateSummary å…§å®¹ï¼Œç”¢å‡ºå¾ŒåŒæ­¥æ›´æ–°è¨˜æ†¶
const originalGenerateSummary = generateSummary;
generateSummary = function () {
  originalGenerateSummary();
  memories[currentMemory] = captureState();
}

// âœ… åˆå§‹åŒ–è¨˜æ†¶1ç‹€æ…‹ï¼ˆåœ¨ onload åŸ·è¡Œå¾Œåšï¼‰
window.addEventListener("load", () => {
  memories[1] = captureState();
});
const serviceOptions = [
  "BA01", "BA02", "BA03", "BA04", "BA05", "BA07", "BA10", "BA11", "BA12", "BA13",
  "BA14", "BA15", "BA16", "BA17a", "BA17b", "BA17c", "BA17d1", "BA17d2", "BA17e",
  "BA18", "BA20", "BA22", "BA23", "BA24",
  "GA09", "SC09", "Cç¢¼(å–®æ¬¡)", "è‡ªè¡Œè¼¸å…¥"
];

let popupCallback = null;

function openPopup(callback) {
  popupCallback = callback;
  const grid = document.getElementById("popupGrid");
  grid.innerHTML = "";

  const columns = 3;
  const total = serviceOptions.length;
  const rows = Math.ceil(total / columns);

  // å»ºç«‹ 3 å€‹æ¬„ä½å®¹å™¨
  const columnContainers = [];
  for (let i = 0; i < columns; i++) {
    const col = document.createElement("div");
    col.style.display = "flex";
    col.style.flexDirection = "column";
    col.style.gap = "0.5em";
    columnContainers.push(col);
    grid.appendChild(col);
  }

  // ç…§ä½ è¦çš„é †åºå¡å…¥ï¼ˆ1â†’11â†’21ï¼‰
  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < columns; col++) {
      const idx = col * rows + row;
      if (idx >= total) continue;
      const opt = serviceOptions[idx];
      const btn = document.createElement("button");
      btn.textContent = opt;
btn.className = "popup-btn";

// âœ… æ ¹æ“šé …ç›®å…§å®¹è¨­å®šå­—é«”é¡è‰²
if (opt === "è‡ªè¡Œè¼¸å…¥") {
  btn.style.color = "#FF5151";
} else if (opt === "GA09" || opt === "SC09") {
  btn.style.color = "#FF0080";
} else if (opt === "Cç¢¼(å–®æ¬¡)") {
  btn.style.color = "#007979";
}

btn.onclick = () => {
  popupCallback(opt);
  closePopup();
};
      columnContainers[col].appendChild(btn);
    }
  }

  document.getElementById("popupSelector").style.display = "flex";
}

function closePopup() {
  document.getElementById("popupSelector").style.display = "none";
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => {
        console.log('Service Worker registered.', reg);
      })
      .catch(err => {
        console.error('Service Worker registration failed:', err);
      });
  });
}
	//å³æ™‚æ›´æ–°
const version = '20240614';
  document.querySelectorAll('link[rel="stylesheet"], script[src], link[rel*="icon"], link[rel="manifest"]').forEach(el => {
    const attr = el.href !== undefined ? 'href' : 'src';
    el[attr] += (el[attr].includes('?') ? '&' : '?') + 'v=' + version;
  });
  </script>

<!-- ğŸ“¦ é …ç›®é¸æ“‡å½ˆçª— -->
<div class="popup-selector" id="popupSelector" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; align-items: center; justify-content: center;">
  <div class="popup-content" style="background: white; padding: 1em; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
    <div id="popupGrid" class="popup-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5em;"></div>
    <div style="margin-top: 1em; text-align: center;">
      <button onclick="closePopup()" style="padding: 0.5em 1em;">å–æ¶ˆ</button>
    </div>
  </div>
</div>
</body>
</html>
